@using AdminMnsV1.Models;
@using AdminMnsV1.Models.ViewModels;
@model AdminMnsV1.Models.CandidaturesModels.CandidatureStudentViewModel

@{
	ViewData["Title"] = "Dossier: " + Model.FirstName + " " + Model.LastName; 
}


<h1 class="mx-5 mt-5">Dossier: @Model.LastName @Model.FirstName</h1>
@{
	var successMessage = TempData["SuccessMessage"] as string;
	var errorMessage = TempData["ErrorMessage"] as string;
}

@if (!string.IsNullOrEmpty(successMessage))
{
	<div class="alert alert-success">
		@successMessage
	</div>
}

@if (!string.IsNullOrEmpty(errorMessage))
{
	<div class="alert alert-danger">
		@errorMessage
	</div>
}



<div class="cardStudent">
	<div class="row g-4 mb-5">
		<div class="col-md-4 col-sm-12">
			<div class="p-3 mb-3 border rounded-3 bg-light studentInfos">
				@* Image de profil de l'étudiant *@
				<img src="@(Model.StudentImage)" alt="@(Model.FirstName) @(Model.LastName)" class="student-image">
				<h4>@(Model.FirstName ?? "N/A") @(Model.LastName ?? "N/A")</h4>
				<span>Classe : @(Model.ClassName ?? "N/A")</span>
				<span>Adresse: @(Model.Address ?? "N/A")</span>
				@* Assurez-vous d'avoir une propriété pour le code postal dans votre ViewModel si vous voulez l'afficher *@
				@* <span>Code postal: @(Model.PostalCode ?? "N/A")</span> *@
				<span>Téléphone: @(Model.Phone ?? "N/A")</span>
				<span>Mail: @(Model.Email ?? "N/A")</span>
				<span>Date de naissance : @(Model.BirthDate.HasValue? Model.BirthDate.Value.ToShortDateString() : "Non spécifié")</span>
			</div>

			<div class="p-3 mb-3 border rounded-3 bg-light studentInfos">
				<div class="student-info-enCours">
					<h5>Statut de la Candidature</h5>
					<span class="badge bg-primary">@Model.CandidatureStatus</span>
					@{

						var safeStatus = Model.CandidatureStatus;
					}
					@if (safeStatus != null && safeStatus.Equals("En cours", StringComparison.OrdinalIgnoreCase))
					{
						<img width="80" height="80" src="https://img.icons8.com/dotty/80/rotate.png" alt="rotate" />
					}
					else if (safeStatus != null && safeStatus.Equals("Validé", StringComparison.OrdinalIgnoreCase))
					{
						<img width="80" height="80" src="https://img.icons8.com/dotty/80/checked--v1.png" alt="checked--v1" />
					}
					else if (safeStatus != null && safeStatus.Equals("Refusé", StringComparison.OrdinalIgnoreCase))
					{
						<img width="80" height="80" src="https://img.icons8.com/dotty/80/cancel.png" alt="cancel" />
					}
				</div>

			</div>
			<div class="p-3 mb-3 border rounded-3 bg-light studentInfos">
				<div class="student-info">
					<h4>
						Promotion: @Model.ClassName @Model.ClassStartDate.ToString("dd/MM/yyyy")
						/ @Model.ClassEndDate.ToString("dd/MM/yyyy")

					</h4> @* Vous pouvez dynamiser cette partie si Model.Promotion existe *@
					<p class="text-justify">
						Lorem ipsum dolor, sit adipisicing elit. Adipisci quis epe
						voluptatem obcaecati, vel, met nesciunt consequatur placecccccccccat reprehenderit.
						amet consectetuccccccccr adipisicing elit.otam minima nostrum nihil illum laborum
						rerum reiciendis facilis cum. Officiisccccc
						expli dohhhhr quaerat maxime dignissimos ab sit possimus repudiandae obcaecati.
					</p>
				</div>
			</div>
		</div>

		<div class="col-md-8 col-sm-12">
			<div class="row g-3 mb-4">
				<div class="col-12">
					<div class="row g-5">
						<div class="col-md-11 col-sm-12 p-3 mx-5 border rounded-3 bg-light">
							<h4 class="mb-4">Progression du dossier</h4>
							<div class="progress" style="height: 50px;">
								<div class="progress-bar" role="progressbar" style="width: @(Model.StudentValidationProgress)%"
									 aria-valuemin="0" aria-valuemax="100" aria-valuenow="@(Model.StudentValidationProgress)">
									@(Model.StudentValidationProgress)%
								</div>
							</div>
							<p>Validation élève</p>
							<div class="progress mt-5 " style="height: 50px;">
								<div class="progress-bar progress-bar-striped bg-warning" role="progressbar"
									 style="width: @(Model.MnsValidationProgress)%" aria-valuemin="0" aria-valuemax="100"
									 aria-valuenow="@(Model.MnsValidationProgress)">
									@(Model.MnsValidationProgress)%
								</div>
							</div>
							<p>Validation MNS</p>
						</div>
					</div>
				</div>
			</div>


			<div class="p-3 g-3 border rounded-3 bg-light">
				<h4>Pièces à fournir</h4>
				<div class="table-responsive">
					<table class="table align-middle table-striped table-hover table-custom bg-secondary">
						<thead>
							<tr>
								<th scope="col">Pièce</th>
								<th scope="col" class="d-none d-md-table-cell">Date</th>
								<th scope="col">Téléchargement</th>
								<th scope="col">Validation</th>
							</tr>
						</thead>
						<tbody>
							@if (Model.RequiredDocuments != null && Model.RequiredDocuments.Any())
							{
								@foreach (var doc in Model.RequiredDocuments)
								{
									// Détermine si le document est déjà uploadé
									var isDocumentUpload = !string.IsNullOrEmpty(doc.DocumentPath) &&
									!doc.DocumentPath.Equals("/uploads/documents/N/A", StringComparison.OrdinalIgnoreCase);
									<tr>
										<td>@doc.DocumentTypeName</td>
										<td class="d-none d-md-table-cell">@doc.UploadDate</td>
										<td>
											@* Afficher le lien si le document est déjà téléchargé *@
											@* 	@if (isDocumentUpload)
											{
												<a href="@Url.Content(doc.DocumentPath)" class="btn btn-info btn-sm" target="_blank">
													<i class="bi bi-file-earmark-text"></i> Voir le document
												</a>
											}
											else
											{
												<span class="text-muted">Non téléchargé</span>
											} *@


											@if (!string.IsNullOrEmpty(doc.DocumentPath))
											{

												@*   <a href="@doc.DocumentPath" class="btn btn-info btn-sm" target="_blank">
                                                    <i class="bi bi-file-earmark-text"></i> Voir
                                                </a> *@
											}
											else
											{
												<span class="text-muted">Non téléchargé</span>
											}
											@* Formulaire d'upload/remplacement pour chaque document *@
											<form asp-action="UploadDocument" asp-controller="CandidaturesStudents" method="post" enctype="multipart/form-data" class="d-inline-block ml-2">
												<input type="hidden" name="candidatureId" value="@Model.CandidatureId" />
												<input type="hidden" name="documentTypeName" value="@doc.DocumentTypeName" />

												@* L'attribut 'disabled' est appliqué conditionnellement *@
												<input type="file" name="document" class="" @(isDocumentUpload ? "disabled" : "") />
												<button type="submit" class="btn btn-primary btn-sm" @(isDocumentUpload ? "disabled" : "")>Télécharger</button>

												@if (isDocumentUpload)
												{
													<span class="text-success ml-2">Déjà envoyé</span>
												}
											</form>
										</td>
										<td>
											@if (doc.IsVerified)
											{
												<span class="badge text-bg-success">Validé</span>
											}
											else if (isDocumentUpload) // Si le document a été envoyé mais pas encore vérifié
											{
												<span class="badge text-bg-warning">En attente</span>
											}
											else if (isDocumentUpload) // Si le document a été envoyé mais a été refusé
											{
												<span class="badge text-bg-danger">Refusé</span>
											}
											else // Si le document n'a pas encore été envoyé (isDocumentUpload est false)
											{
												<span class="badge text-bg-secondary">Manquant</span>
											}

											@* Boutons Valider/Rejeter si l'utilisateur est un administrateur/MNS - Mettre cette logique SEPAREMENT, si c'est pour un admin *@
											@* Si c'est pour l'élève, ces boutons ne devraient pas être visibles. * @
											@* if (User.IsInRole("Admin") || User.IsInRole("MNS"))
											{
												// Ces formulaires ne devraient apparaître que pour les admins, et seulement pour les documents "En attente" ou "Rejeté"
												// Ils ne font pas partie du statut de l'élève
											} *@
										</td>
									</tr>
								}
							}
							else
							{
								<tr>
									<td colspan="5">Aucun document n'a été trouvé pour cette candidature.</td>
								</tr>
							}
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</div>
</div>

@section Scripts {
	@{
		await Html.RenderPartialAsync("_ValidationScriptsPartial");
	}
}